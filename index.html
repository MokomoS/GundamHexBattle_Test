<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機動戦士ガンダム 一年戦争オンラインボードゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #111827; color: #e5e7eb; }
        .font-roberto-mono { font-family: 'Roboto Mono', monospace; }
        #game-board { display: grid; grid-template-columns: repeat(20, 50px); gap: 4px; }
        .hex { position: relative; width: 50px; height: 57.74px; background-color: #374151; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); transition: background-color 0.2s; }
        .hex:hover { background-color: #4b5563; }
        .hex.highlight-move { background-color: #60a5fa; opacity: 0.7; cursor: pointer; }
        .hex.highlight-attack { background-color: #f87171; opacity: 0.7; cursor: pointer; }
        .hex.highlight-place { background-color: #a7f3d0; opacity: 0.7; cursor: pointer; }
        .unit { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 45px; height: 45px; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid white; cursor: pointer; transition: all 0.3s ease; }
        .unit.federation { border-color: #60a5fa; }
        .unit.zeon { border-color: #4ade80; }
        .unit.selected { border-color: #facc15; transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 15px #facc15; }
        .unit.acted { filter: grayscale(80%); }
        .hand-card { cursor: pointer; transition: all 0.2s ease; }
        .hand-card:hover { transform: translateY(-5px) scale(1.05); }
        .hand-card.selected { border: 2px solid #facc15; box-shadow: 0 0 10px #facc15; }
        .modal { backdrop-filter: blur(5px); }
    </style>
</head>
<body class="p-2 md:p-4">

    <!-- Title Screen Modal -->
    <div id="title-screen-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-lg shadow-2xl text-center max-w-md w-full">
            <h1 class="text-4xl font-bold mb-2 font-roberto-mono text-yellow-300">一年戦争</h1>
            <h2 class="text-xl font-bold mb-8 font-roberto-mono">HEX BATTLE</h2>
            <button id="start-auth-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded transition-colors">ゲームスタート</button>
            <p id="auth-loading-text" class="text-sm text-gray-400 mt-4 hidden">認証中...</p>
        </div>
    </div>


    <!-- Lobby Modal -->
    <div id="lobby-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 p-8 rounded-lg shadow-2xl text-center max-w-md w-full">
            <h2 class="text-3xl font-bold mb-6 font-roberto-mono">オンラインロビー</h2>
            <div id="initial-options">
                <button id="create-game-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded mb-4 transition-colors">ゲームを作成</button>
                <button id="show-join-ui-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded transition-colors">ゲームに参加</button>
            </div>
            <div id="join-game-ui" class="hidden">
                <input type="text" id="game-code-input" placeholder="招待コードを入力" class="w-full bg-gray-700 text-white p-3 rounded mb-4 text-center tracking-widest font-roberto-mono">
                <button id="join-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded mb-2 transition-colors">参加</button>
                <button id="back-to-initial-btn" class="w-full text-gray-400 hover:text-white py-2">戻る</button>
            </div>
            <div id="lobby-wait-ui" class="hidden">
                <h3 class="text-xl mb-4">ロビー</h3>
                <p class="mb-2">招待コード:</p>
                <div class="bg-gray-800 p-3 rounded mb-4 flex items-center justify-center">
                    <span id="game-code-display" class="text-2xl font-bold text-yellow-400 tracking-widest font-roberto-mono mr-4"></span>
                    <button id="copy-code-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-2 rounded">コピー</button>
                </div>
                <div class="mb-4">
                    <label for="scenario-select" class="block mb-2">シナリオ選択:</label>
                    <select id="scenario-select" class="w-full bg-gray-700 text-white p-2 rounded">
                        <option value="side7">サイド7強襲</option>
                        <option value="odessa">オデッサ作戦</option>
                    </select>
                </div>
                <h4 class="text-lg mb-2">参加プレイヤー:</h4>
                <ul id="player-list" class="mb-4 text-left space-y-2"></ul>
                <button id="start-game-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded transition-colors disabled:bg-gray-600" disabled>ゲーム開始</button>
            </div>
            <p id="lobby-error" class="text-red-400 mt-4"></p>
        </div>
    </div>
    
    <div id="game-container" class="hidden">
        <div class="max-w-screen-2xl mx-auto grid grid-cols-12 gap-4">
            <!-- Left Panel -->
            <div class="col-span-12 lg:col-span-3 bg-gray-900 p-4 rounded-lg shadow-lg space-y-4">
                <div id="player-info" class="p-3 bg-gray-800 rounded-md"></div>
                <div id="turn-info">
                    <h2 id="turn-indicator" class="text-2xl font-bold font-roberto-mono text-center">TURN 1</h2>
                    <div id="phase-indicator" class="text-lg text-amber-400 font-roberto-mono text-center mt-1"></div>
                </div>
                <div id="unit-info" class="p-3 bg-gray-800 rounded-md h-40 overflow-y-auto hidden"></div>
                <div id="action-buttons" class="space-y-2">
                    <button id="end-phase-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors">フェーズ終了</button>
                </div>
                <div id="game-log" class="p-3 bg-gray-800 rounded-md h-64 overflow-y-auto text-sm">
                    <h4 class="font-bold mb-2">ゲームログ</h4>
                    <div id="log-messages"></div>
                </div>
            </div>
            <!-- Center Panel -->
            <div class="col-span-12 lg:col-span-9 bg-gray-900 p-4 rounded-lg shadow-lg flex items-center justify-center">
                <div id="game-board"></div>
            </div>
        </div>
        <!-- Bottom Panel -->
        <div class="max-w-screen-2xl mx-auto mt-4 bg-gray-900 p-4 rounded-lg shadow-lg">
            <h3 id="hand-title" class="text-lg font-bold mb-2">あなたの手札</h3>
            <div id="player-hand-area" class="player-hand flex space-x-2 overflow-x-auto pb-4"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- グローバル変数と定数 ---
        const BOARD_COLS = 20;
        const BOARD_ROWS = 12;
        const placeholderImg = 'https://placehold.co/50x50/e2e8f0/4a5568?text=MS';
        
        let firebaseApp, auth, db;
        let localGameState = {};
        let localPlayerId = null;
        let gameUnsubscribe = null;
        let selectedHandCardId = null;
        let selectedUnitId = null;

        const ui = {
            titleScreen: document.getElementById('title-screen-modal'),
            authLoadingText: document.getElementById('auth-loading-text'),
            startAuthBtn: document.getElementById('start-auth-btn'),
            lobby: {
                modal: document.getElementById('lobby-modal'),
                initial: document.getElementById('initial-options'),
                createGameBtn: document.getElementById('create-game-btn'),
                showJoinUiBtn: document.getElementById('show-join-ui-btn'),
                joinUI: document.getElementById('join-game-ui'),
                joinGameBtn: document.getElementById('join-game-btn'),
                backToInitialBtn: document.getElementById('back-to-initial-btn'),
                waitUI: document.getElementById('lobby-wait-ui'),
                codeInput: document.getElementById('game-code-input'),
                codeDisplay: document.getElementById('game-code-display'),
                copyCodeBtn: document.getElementById('copy-code-btn'),
                playerList: document.getElementById('player-list'),
                startGameBtn: document.getElementById('start-game-btn'),
                scenarioSelect: document.getElementById('scenario-select'),
                error: document.getElementById('lobby-error'),
            },
            game: {
                container: document.getElementById('game-container'),
                board: document.getElementById('game-board'),
                playerInfo: document.getElementById('player-info'),
                turnIndicator: document.getElementById('turn-indicator'),
                phaseIndicator: document.getElementById('phase-indicator'),
                unitInfo: document.getElementById('unit-info'),
                endPhaseBtn: document.getElementById('end-phase-btn'),
                logMessages: document.getElementById('log-messages'),
                handArea: document.getElementById('player-hand-area'),
            }
        };
        
        const allCards = {
            'RX-78-2': { id: 'RX-78-2', name: "RX-78-2 ガンダム", side: 'federation', hp: 55, en: 40, move: 6, weapons: [{name: 'Beam Rifle', range: 5, damage: 20, cost: 5}], img: 'https://www.gundam.jp/tv/world/mechanic/images/me_gundam.png'},
            'RGM-79': { id: 'RGM-79', name: "RGM-79 ジム", side: 'federation', hp: 30, en: 25, move: 5, weapons: [{name: 'Beam Spray Gun', range: 3, damage: 12, cost: 3}], img: 'https://www.gundam.jp/tv/world/mechanic/images/me_gm.png'},
            'MS-06F': { id: 'MS-06F', name: "MS-06F ザクII", side: 'zeon', hp: 28, en: 25, move: 5, weapons: [{name: 'Machine Gun', range: 4, damage: 10, cost: 2}], img: 'https://www.gundam.jp/tv/world/mechanic/images/me_zaku.png'},
            'MS-06S': { id: 'MS-06S', name: "シャア専用ザクII", side: 'zeon', hp: 35, en: 30, move: 7, weapons: [{name: 'Machine Gun', range: 4, damage: 12, cost: 3}], img: 'https://www.gundam.jp/tv/world/mechanic/images/me_charzaku.png'},
        };
        const scenarios = {
            side7: { name: 'サイド7強襲', federationStartZone: {x: 0, y: 0, w: 3, h: 12}, zeonStartZone: {x: 17, y: 0, w: 3, h: 12} },
            odessa: { name: 'オデッサ作戦', federationStartZone: {x: 0, y: 0, w: 20, h: 2}, zeonStartZone: {x: 0, y: 10, w: 20, h: 2} }
        };

        // --- Firebase初期化と認証 ---
        async function handleGameStart() {
            ui.authLoadingText.classList.remove('hidden');
            ui.startAuthBtn.disabled = true;
            
            const firebaseConfig = {
                apiKey: "AIzaSyBEp2wuVwup6lyrUYVxim4EuQLrrKgBFTk",
                authDomain: "gumdamhexbattle.firebaseapp.com",
                projectId: "gumdamhexbattle",
                storageBucket: "gumdamhexbattle.appspot.com",
                messagingSenderId: "828995733517",
                appId: "1:828995733517:web:29d2ff0781257a2df5ad44"
            };

            try {
                if (!firebaseApp) {
                    firebaseApp = initializeApp(firebaseConfig);
                    auth = getAuth(firebaseApp);
                    db = getFirestore(firebaseApp);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        localPlayerId = user.uid;
                        console.log("Authenticated with ID:", localPlayerId);
                        ui.titleScreen.classList.add('hidden');
                        ui.lobby.modal.classList.remove('hidden');
                    }
                });

                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                } else {
                    localPlayerId = auth.currentUser.uid;
                    ui.titleScreen.classList.add('hidden');
                    ui.lobby.modal.classList.remove('hidden');
                }

            } catch(error) {
                console.error("Firebase Initialization/Auth Error:", error);
                ui.authLoadingText.classList.add('text-red-500');
                if (error.code === 'auth/configuration-not-found') {
                    ui.authLoadingText.innerHTML = `Firebase設定エラー: 匿名認証が有効になっていません。<br>Firebaseコンソールで設定を確認してください。`;
                    alert("Firebase設定エラー (auth/configuration-not-found):\n\nこのアプリでは「匿名認証」が必要です。Firebaseプロジェクトで有効にしてください。\n\n手順:\n1. Firebaseコンソール > Authentication > Sign-in method\n2. プロバイダリストから「匿名」を選択し、有効にして保存します。");
                } else {
                    ui.authLoadingText.textContent = `認証エラー: ${error.message}`;
                    alert(`Firebaseの初期化または認証に失敗しました。コンソールのエラーメッセージを確認してください。\nError: ${error.message}`);
                }
                ui.startAuthBtn.disabled = false;
            }
        }
        
        // --- UI表示切り替え ---
        function showJoinUI() { ui.lobby.initial.classList.add('hidden'); ui.lobby.joinUI.classList.remove('hidden'); };
        function showInitialUI() { ui.lobby.joinUI.classList.add('hidden'); ui.lobby.initial.classList.remove('hidden'); };
        
        // --- ゲーム作成と参加 ---
        async function createGame() {
            if (!localPlayerId) { alert("認証が完了していません。"); return; }
            ui.lobby.createGameBtn.disabled = true;

            try {
                const gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
                const hostPlayer = { id: localPlayerId, name: `Player ${Math.floor(Math.random() * 1000)}`, side: null, isHost: true };
                const initialGameState = {
                    gameId: gameId,
                    status: 'lobby',
                    players: { [localPlayerId]: hostPlayer },
                    scenario: 'side7',
                    log: [`ゲーム[${gameId}]が作成されました。`],
                    createdAt: serverTimestamp()
                };

                const gameRef = doc(db, 'games', gameId);
                await setDoc(gameRef, initialGameState);
                await attachToGame(gameId);
            } catch (error) {
                console.error("Error creating game:", error);
                if (error.code === 'permission-denied') {
                    ui.lobby.error.textContent = "データベースへの書き込み権限がありません。Firestoreのセキュリティルールを確認してください。";
                    alert("Firestoreセキュリティルールエラー:\n\nデータベースへの書き込みが拒否されました。これは通常、セキュリティルールが設定されていないか、正しくないことが原因です。\n\n次の手順でルールを更新してください:\n1. FirebaseコンソールでFirestore Databaseを開く\n2. 「ルール」タブを選択\n3. 以下のルールを貼り付けて公開する:\n\nrules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /games/{gameId} {\n      allow read, write: if request.auth != null;\n    }\n  }\n}");
                } else {
                    ui.lobby.error.textContent = "ゲームの作成に失敗しました。コンソールを確認してください。";
                }
                ui.lobby.createGameBtn.disabled = false;
            }
        };
        
        async function joinGame() {
            const gameId = ui.lobby.codeInput.value.toUpperCase();
            if (!gameId) { ui.lobby.error.textContent = "招待コードを入力してください。"; return; }
            if (!localPlayerId) { alert("認証が完了していません。"); return; }

            const gameRef = doc(db, 'games', gameId);
            try {
                const gameSnap = await getDoc(gameRef);

                if (gameSnap.exists()) {
                    const gameData = gameSnap.data();
                    if (Object.keys(gameData.players).length >= 4) { ui.lobby.error.textContent = "このゲームは満員です。"; return; }
                    const newPlayer = { id: localPlayerId, name: `Player ${Math.floor(Math.random() * 1000)}`, side: null, isHost: false };
                    await updateDoc(gameRef, { [`players.${localPlayerId}`]: newPlayer });
                    await attachToGame(gameId);
                } else {
                    ui.lobby.error.textContent = "ゲームが見つかりません。";
                }
            } catch (error) {
                 console.error("Error joining game:", error);
                 ui.lobby.error.textContent = "ゲームへの参加に失敗しました。";
            }
        };

        async function attachToGame(gameId) {
            ui.lobby.initial.classList.add('hidden');
            ui.lobby.joinUI.classList.add('hidden');
            ui.lobby.waitUI.classList.remove('hidden');
            ui.lobby.codeDisplay.textContent = gameId;

            if (gameUnsubscribe) gameUnsubscribe();
            
            gameUnsubscribe = onSnapshot(doc(db, 'games', gameId), (docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    localGameState = gameData;
                    renderLobby(gameData);
                    
                    if (gameData.status !== 'lobby') {
                        ui.lobby.modal.classList.add('hidden');
                        ui.game.container.classList.remove('hidden');
                        renderGame(gameData);
                    }
                } else {
                    alert("ゲームが終了または削除されました。");
                    if(gameUnsubscribe) gameUnsubscribe();
                    location.reload();
                }
            });
        }
        
        function renderLobby(gameData) {
            const players = Object.values(gameData.players);
            ui.lobby.playerList.innerHTML = players.map(p => {
                if(p.id === localPlayerId) {
                    return `<li class="flex items-center">
                                <input type="text" data-player-id="${p.id}" value="${p.name}" class="player-name-input bg-gray-700 text-white p-1 rounded w-full">
                                <span class="ml-2 text-yellow-400">(あなた)</span>
                            </li>`;
                }
                return `<li class="p-1">${p.name} ${p.isHost ? '(ホスト)' : ''}</li>`;
            }).join('');
            
            const isHost = gameData.players[localPlayerId]?.isHost;
            ui.lobby.scenarioSelect.disabled = !isHost;
            ui.lobby.startGameBtn.disabled = players.length < 2 || !isHost;

            if (isHost) {
                ui.lobby.scenarioSelect.onchange = () => {
                    updateDoc(doc(db, 'games', gameData.gameId), { scenario: ui.lobby.scenarioSelect.value });
                };
            } else {
                 ui.lobby.scenarioSelect.value = gameData.scenario;
            }
        }

        async function updatePlayerName(playerId, newName) {
            if (!localGameState.gameId || !playerId) return;
            const gameRef = doc(db, 'games', localGameState.gameId);
            await updateDoc(gameRef, {
                [`players.${playerId}.name`]: newName
            });
        }

        function copyGameCode() {
            const code = ui.lobby.codeDisplay.textContent;
            navigator.clipboard.writeText(code).then(() => {
                ui.lobby.copyCodeBtn.textContent = 'コピー完了!';
                setTimeout(() => { ui.lobby.copyCodeBtn.textContent = 'コピー'; }, 2000);
            }).catch(err => console.error('コピーに失敗しました', err));
        }
        
        // --- ゲーム開始処理 ---
        async function startGame() {
            if (!localGameState || !localGameState.gameId) return;
            const gameRef = doc(db, 'games', localGameState.gameId);
            let playersData = localGameState.players;
            const playerIds = Object.keys(playersData);
            
            let shuffledPlayerIds = playerIds.sort(() => 0.5 - Math.random());
            let fedCount = Math.ceil(playerIds.length / 2);
            
            shuffledPlayerIds.forEach((id, i) => {
                playersData[id].side = i < fedCount ? 'federation' : 'zeon';
            });

            dealCards(playersData);
            
            const newState = {
                ...localGameState,
                players: playersData,
                status: 'placement',
                phase: 'PLACEMENT',
                turn: 1,
                currentPlayerSide: 'federation',
                board: createBoard(),
                units: [],
                log: [...localGameState.log, "ゲーム開始！ユニット配置フェーズです。"],
            };
            
            await setDoc(gameRef, newState);
        };
        
        function dealCards(playersData) {
            const fedDeck = Object.values(allCards).filter(c => c.side === 'federation');
            const zeonDeck = Object.values(allCards).filter(c => c.side === 'zeon');
            
            Object.values(playersData).forEach(player => {
                const deckSource = player.side === 'federation' ? fedDeck : zeonDeck;
                player.hand = deckSource.map(c => ({...c, handId: `${c.id}-${Math.random().toString(36).substr(2, 5)}`}));
            });
        }
        
        function createBoard() {
            let board = [];
            for (let r = 0; r < BOARD_ROWS; r++) {
                for (let c = 0; c < BOARD_COLS; c++) {
                    board.push({ x: c, y: r, unitId: null, terrain: 'space' });
                }
            }
            return board;
        }

        // --- ゲームレンダリング ---
        function renderGame(gs) {
            localGameState = gs;
            renderBoard();
            renderAllUnits();
            renderPlayerInfo();
            renderHand();
            updateGameInfo();
            updateLog();
        }

        function renderBoard() {
            if (ui.game.board.children.length > 0) return;
            ui.game.board.innerHTML = ''; // Clear board before rendering
            for (let r = 0; r < BOARD_ROWS; r++) {
                for (let c = 0; c < BOARD_COLS; c++) {
                    const hex = document.createElement('div');
                    hex.classList.add('hex');
                    hex.dataset.x = c;
                    hex.dataset.y = r;
                    hex.addEventListener('click', () => onHexClick(c, r));
                    ui.game.board.appendChild(hex);
                }
            }
        }
        
        function renderAllUnits() {
            document.querySelectorAll('.unit').forEach(u => u.remove());
            localGameState.units?.forEach(unit => {
                const hex = document.querySelector(`.hex[data-x='${unit.x}'][data-y='${unit.y}']`);
                if (hex) {
                    const unitEl = document.createElement('div');
                    unitEl.id = unit.id;
                    unitEl.classList.add('unit', unit.side);
                    if (unit.hasActed) unitEl.classList.add('acted');
                    if (unit.id === selectedUnitId) unitEl.classList.add('selected');
                    unitEl.style.backgroundImage = `url(${unit.img || placeholderImg})`;
                    unitEl.addEventListener('click', (e) => { e.stopPropagation(); onUnitClick(unit.id); });
                    hex.appendChild(unitEl);
                }
            });
        }

        function renderPlayerInfo() {
            const player = localGameState.players?.[localPlayerId];
            if (!player) return;
            const sideColor = player.side === 'federation' ? 'text-blue-400' : 'text-green-400';
            ui.game.playerInfo.innerHTML = `<h3 class="font-bold text-lg text-center ${sideColor}">${player.name} (${player.side === 'federation' ? '地球連邦軍' : 'ジオン公国軍'})</h3>`;
        }
        
        function renderHand() {
            const player = localGameState.players?.[localPlayerId];
            if (!player?.hand) {
                 ui.game.handArea.innerHTML = '';
                 return;
            }
            ui.game.handArea.innerHTML = player.hand.map(card => `
                <div data-hand-id="${card.handId}" class="hand-card bg-gray-800 p-2 rounded w-32 flex-shrink-0 ${selectedHandCardId === card.handId ? 'selected' : ''}">
                    <img src="${card.img}" class="w-full h-16 object-cover rounded-sm mb-2" onerror="this.onerror=null;this.src='${placeholderImg}';">
                    <p class="text-xs font-bold whitespace-nowrap overflow-hidden text-ellipsis">${card.name}</p>
                </div>
            `).join('');
            
            document.querySelectorAll('.hand-card').forEach(cardEl => {
                cardEl.addEventListener('click', () => onHandCardClick(cardEl.dataset.handId));
            });
        }
        
        function updateGameInfo() {
            if(!localGameState || !localGameState.players) return;
            ui.game.turnIndicator.textContent = `TURN ${localGameState.turn || 1}`;
            const phaseMap = { PLACEMENT: '配置フェーズ', STRATEGY: '戦略フェーズ', EXECUTION: '実行フェーズ', COMBAT: '戦闘フェーズ' };
            ui.game.phaseIndicator.textContent = phaseMap[localGameState.phase] || '待機中';

            const player = localGameState.players?.[localPlayerId];
            const isMyTurn = localGameState.currentPlayerSide === player?.side;
            ui.game.endPhaseBtn.disabled = !isMyTurn;
            ui.game.endPhaseBtn.textContent = isMyTurn ? "フェーズ終了" : "相手ターン";
        }
        
        function updateLog() {
            if(!ui.game.logMessages || !localGameState.log) return;
            ui.game.logMessages.innerHTML = localGameState.log.slice(-20).map(msg => `<div>${msg}</div>`).join('');
            ui.game.logMessages.scrollTop = ui.game.logMessages.scrollHeight;
        }

        // --- ゲーム内アクション ---
        function onHandCardClick(handId) {
            const player = localGameState.players?.[localPlayerId];
            if (!player || localGameState.phase !== 'PLACEMENT' || localGameState.currentPlayerSide !== player.side) return;
            
            selectedHandCardId = handId;
            selectedUnitId = null;
            renderHand();
            
            const scenario = scenarios[localGameState.scenario];
            const zone = player.side === 'federation' ? scenario.federationStartZone : scenario.zeonStartZone;
            highlightPlacementZone(zone);
        }
        
        function onUnitClick(unitId) {
             const player = localGameState.players?.[localPlayerId];
             if (!player || localGameState.phase !== 'STRATEGY' || localGameState.currentPlayerSide !== player.side) return;
             const unit = localGameState.units.find(u => u.id === unitId);
             if(!unit || unit.owner !== localPlayerId || unit.hasActed) return;
             
             selectedUnitId = unitId;
             selectedHandCardId = null;
             renderAllUnits();
        }
        
        async function onHexClick(x, y) {
            const player = localGameState.players?.[localPlayerId];
            if (!player) return;

            if (localGameState.phase === 'PLACEMENT' && selectedHandCardId) {
                const cardInHand = player.hand.find(c => c.handId === selectedHandCardId);
                if(!cardInHand) return;

                const newUnit = {
                    ...cardInHand,
                    id: `${cardInHand.id}-${Math.random().toString(36).substr(2, 5)}`,
                    currentHp: cardInHand.hp,
                    x: parseInt(x), y: parseInt(y),
                    owner: localPlayerId,
                    side: player.side,
                    hasActed: false
                };
                
                const newHand = player.hand.filter(c => c.handId !== selectedHandCardId);
                const updatedUnits = [...(localGameState.units || []), newUnit];
                
                const gameRef = doc(db, 'games', localGameState.gameId);
                await updateDoc(gameRef, {
                    units: updatedUnits,
                    [`players.${localPlayerId}.hand`]: newHand,
                    log: [...localGameState.log, `${player.name}が${newUnit.name}を(${x},${y})に配置。`]
                });
                
                selectedHandCardId = null;
                clearHighlights();
            }
        }
        
        async function endPhase() {
            if(!localGameState.gameId) return;
            const gameRef = doc(db, 'games', localGameState.gameId);
            let updates = {};
            let newLog = [...localGameState.log];
            const mySide = localGameState.players[localPlayerId].side;

            if (localGameState.phase === 'PLACEMENT') {
                const teamPlayers = Object.values(localGameState.players).filter(p => p.side === mySide);
                const allTeamPlaced = teamPlayers.every(p => p.hand.length === 0);

                if (allTeamPlaced) {
                    newLog.push(`${mySide}チームが配置を完了しました。`);
                    
                    const nextSide = mySide === 'federation' ? 'zeon' : 'federation';
                    const nextTeamPlayers = Object.values(localGameState.players).filter(p => p.side === nextSide);
                    const isNextTeamPlaced = nextTeamPlayers.every(p => p.hand.length === 0);

                    if(isNextTeamPlaced) {
                        updates.phase = 'STRATEGY';
                        updates.currentPlayerSide = 'federation';
                        newLog.push("全ユニット配置完了。戦略フェーズ開始！");
                    } else {
                        updates.currentPlayerSide = nextSide;
                        newLog.push(`${updates.currentPlayerSide === 'federation' ? '地球連邦軍' : 'ジオン公国軍'}の配置フェーズです。`);
                    }
                } else {
                    alert("まだ配置できるユニットがあります。");
                    return;
                }
            } else if (localGameState.phase === 'STRATEGY') {
                // 戦略フェーズから実行フェーズへの移行ロジック (TODO)
            }
            
            updates.log = newLog;
            await updateDoc(gameRef, updates);
        }
        
        function highlightPlacementZone(zone) {
            clearHighlights();
            document.querySelectorAll('.hex').forEach(hex => {
                const x = parseInt(hex.dataset.x);
                const y = parseInt(hex.dataset.y);
                if (x >= zone.x && x < zone.x + zone.w && y >= zone.y && y < zone.y + zone.h) {
                    hex.classList.add('highlight-place');
                }
            });
        }

        function clearHighlights() {
            document.querySelectorAll('.hex').forEach(h => {
                h.classList.remove('highlight-move', 'highlight-attack', 'highlight-place');
            });
        }
        
        // --- イベントリスナーの登録 ---
        ui.startAuthBtn.addEventListener('click', handleGameStart);
        ui.lobby.createGameBtn.addEventListener('click', createGame);
        ui.lobby.showJoinUiBtn.addEventListener('click', showJoinUI);
        ui.lobby.joinGameBtn.addEventListener('click', joinGame);
        ui.lobby.backToInitialBtn.addEventListener('click', showInitialUI);
        ui.lobby.startGameBtn.addEventListener('click', startGame);
        ui.lobby.copyCodeBtn.addEventListener('click', copyGameCode);
        ui.game.endPhaseBtn.addEventListener('click', endPhase);
        
        // プレイヤー名変更イベントリスナーを委譲
        ui.lobby.playerList.addEventListener('change', (event) => {
            const target = event.target;
            if (target.tagName === 'INPUT' && target.classList.contains('player-name-input')) {
                updatePlayerName(target.dataset.playerId, target.value);
            }
        });

    </script>
</body>
</html>
